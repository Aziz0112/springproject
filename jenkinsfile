pipeline {
    agent any

    environment {
        // Configuration Git
        GIT_REPO = 'https://github.com/Aziz0112/springproject.git'
        GIT_BRANCH = 'main'

        // Configuration SonarQube
        SONAR_HOST_URL = 'http://192.168.33.10:9000'
        SONAR_PROJECT_KEY = 'azizproject'

        // Configuration Docker Hub
        DOCKER_HUB_CREDENTIALS = 'docker-hub-credentials'
        DOCKER_IMAGE_NAME = 'nsiriaziz/springproject'
        DOCKER_IMAGE_TAG = "${BUILD_NUMBER}"

        // Namespace Kubernetes
        K8S_NAMESPACE = 'default'
    }

    tools {
        maven 'maven-3.6.3'
        jdk 'JAVA_HOME'
    }

    stages {
        stage('1. R√©cup√©ration du code depuis Git') {
            steps {
                echo 'üì• Clonage du repository Git...'
                git branch: "${GIT_BRANCH}",
                    credentialsId: 'git-credentials',
                    url: "${GIT_REPO}"

                sh '''
                    echo "üìÇ V√©rification des fichiers..."
                    ls -la

                    # V√©rifier et renommer DockerFile en Dockerfile si n√©cessaire
                    if [ -f "DockerFile" ]; then
                        echo "‚ö†Ô∏è DockerFile d√©tect√©, renommage..."
                        mv DockerFile Dockerfile
                    fi

                    if [ ! -f "Dockerfile" ]; then
                        echo "‚ùå Dockerfile manquant!"
                        exit 1
                    fi

                    # V√©rifier le dossier K8s
                    if [ -d "K8s" ]; then
                        echo "‚úÖ Dossier K8s trouv√©"
                        ls -la K8s/
                    fi
                '''
                echo '‚úÖ Code r√©cup√©r√© avec succ√®s'
            }
        }

        stage('2. Clean') {
            steps {
                echo 'üßπ Nettoyage du projet...'
                sh 'mvn clean'
                echo '‚úÖ Nettoyage termin√©'
            }
        }

        stage('3. Compile') {
            steps {
                echo '‚öôÔ∏è Compilation du projet...'
                sh 'mvn compile'
                echo '‚úÖ Compilation termin√©e'
            }
        }

        stage('4. Analyse SonarQube') {
            steps {
                echo 'üìä Analyse de la qualit√© du code avec SonarQube...'
                withSonarQubeEnv('SonarQubeServer') {
                    sh """
                        mvn sonar:sonar \
                          -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                          -Dsonar.projectName='Aziz Spring Project'
                    """
                }
                echo '‚úÖ Analyse envoy√©e √† SonarQube'
                echo "üìä Consultez les r√©sultats sur: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"
            }
        }

        stage('5. Package') {
            steps {
                echo 'üì¶ G√©n√©ration du fichier JAR...'
                sh 'mvn package -DskipTests'

                sh '''
                    echo "üì¶ V√©rification du JAR cr√©√©:"
                    ls -lh target/*.jar
                '''
                echo '‚úÖ Fichier JAR g√©n√©r√© avec succ√®s'
            }
        }

        stage('6. Archive Artifacts') {
            steps {
                echo 'üíæ Archivage de l\'artifact JAR...'
                archiveArtifacts artifacts: 'target/*.jar',
                                fingerprint: true,
                                allowEmptyArchive: false
                echo '‚úÖ Artifact archiv√©'
            }
        }

        stage('7. Build Docker Image') {
            steps {
                echo 'üê≥ Construction de l\'image Docker...'

                sh '''
                    echo "üîç V√©rification avant build Docker:"
                    ls -la Dockerfile
                    ls -la target/*.jar
                '''

                sh """
                    docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
                    docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:latest
                """

                sh '''
                    echo "‚úÖ Images Docker cr√©√©es:"
                    docker images | grep nsiriaziz/springproject
                '''

                echo "‚úÖ Image Docker cr√©√©e: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
            }
        }

        stage('8. Push Docker Image') {
            steps {
                echo 'üì§ Push de l\'image vers Docker Hub...'
                withCredentials([usernamePassword(
                    credentialsId: "${DOCKER_HUB_CREDENTIALS}",
                    usernameVariable: 'DOCKER_USER',
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh """
                        echo "üîê Connexion √† Docker Hub..."
                        echo \${DOCKER_PASS} | docker login -u \${DOCKER_USER} --password-stdin

                        echo "üì§ Push de l'image avec tag ${DOCKER_IMAGE_TAG}..."
                        docker push ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}

                        echo "üì§ Push de l'image avec tag latest..."
                        docker push ${DOCKER_IMAGE_NAME}:latest

                        echo "üîì D√©connexion..."
                        docker logout
                    """
                }
                echo "‚úÖ Image pouss√©e sur Docker Hub: https://hub.docker.com/r/nsiriaziz/springproject"
            }
        }

        stage('9. Clean Docker Images') {
            steps {
                echo 'üßπ Nettoyage des images Docker locales...'
                sh """
                    docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
                    docker rmi ${DOCKER_IMAGE_NAME}:latest || true
                """
                echo '‚úÖ Images locales nettoy√©es'
            }
        }

        stage('10. Deploy to Kubernetes') {
            steps {
                script {
                    echo '‚ò∏Ô∏è D√©ploiement sur Kubernetes...'

                    // Option avec credentials (si Kubernetes distant)
                    // D√©commentez si vous utilisez des credentials
                    /*
                    withCredentials([file(credentialsId: 'kubernetes-config', variable: 'KUBECONFIG')]) {
                        sh '''
                            export KUBECONFIG=$KUBECONFIG

                            if [ -d "K8s" ]; then
                                echo "üì¶ Application des manifests depuis K8s/"
                                kubectl apply -f K8s/

                                # Attendre que les d√©ploiements soient pr√™ts
                                kubectl rollout status deployment/springproject-deployment -n ${K8S_NAMESPACE} --timeout=300s || true
                            else
                                echo "‚ö†Ô∏è Dossier K8s/ non trouv√©"
                            fi

                            echo "=== PODS ==="
                            kubectl get pods -n ${K8S_NAMESPACE}

                            echo "=== SERVICES ==="
                            kubectl get svc -n ${K8S_NAMESPACE}
                        '''
                    }
                    */

                    // Option sans credentials (si Kubernetes local)
                    // D√©commentez si Kubernetes est sur le m√™me serveur que Jenkins

                    sh """
                        if [ -d "K8s" ]; then
                            echo "üì¶ Application des manifests depuis K8s/"
                            kubectl apply -f K8s/

                            # Attendre que les d√©ploiements soient pr√™ts
                            kubectl rollout status deployment/springproject-deployment -n ${K8S_NAMESPACE} --timeout=300s || true
                        else
                            echo "‚ö†Ô∏è Dossier K8s/ non trouv√©"
                        fi

                        echo "=== PODS ==="
                        kubectl get pods -n ${K8S_NAMESPACE} || true

                        echo "=== SERVICES ==="
                        kubectl get svc -n ${K8S_NAMESPACE} || true
                    """


                    echo '‚úÖ D√©ploiement Kubernetes termin√©!'
                }
            }
        }

        stage('11. V√©rification du d√©ploiement') {
            steps {
                echo 'üîç V√©rification du d√©ploiement...'
                sh """
                    echo "=== INFORMATIONS DE D√âPLOIEMENT ==="
                    kubectl get all -n ${K8S_NAMESPACE} | grep springproject || true

                    echo ""
                    echo "=== URL D'ACC√àS ==="
                    echo "Service accessible via NodePort"
                    NODE_IP=\$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}' 2>/dev/null || echo "localhost")
                    echo "URL: http://\${NODE_IP}:30080"
                """
                echo '‚úÖ V√©rification termin√©e'
            }
        }
    }

    post {
        success {
            echo '‚úÖ Pipeline CI/CD ex√©cut√© avec succ√®s!'
            echo "üì¶ Artifact JAR disponible dans Jenkins"
            echo "üìä R√©sultats SonarQube: ${SONAR_HOST_URL}/dashboard?id=${SONAR_PROJECT_KEY}"
            echo "üê≥ Image Docker: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
            echo "üîó Docker Hub: https://hub.docker.com/r/nsiriaziz/springproject"
            echo ""
            echo "üì• Commande pour pull:"
            echo "   docker pull ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
            echo ""
            echo "üöÄ Commande pour run:"
            echo "   docker run -p 8080:8080 ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
            echo ""
            echo "‚ò∏Ô∏è Application d√©ploy√©e sur Kubernetes dans le namespace '${K8S_NAMESPACE}'"
        }

        failure {
            echo '‚ùå Le pipeline a √©chou√©! V√©rifiez les logs ci-dessus.'
            echo 'üí° Assurez-vous que:'
            echo '   - Les credentials Git sont configur√©s'
            echo '   - SonarQube est accessible'
            echo '   - Maven est correctement install√©'
            echo '   - Docker est install√© et accessible'
            echo '   - Les credentials Docker Hub sont configur√©s'
            echo '   - Le Dockerfile existe √† la racine du projet'
            echo '   - Kubernetes est configur√© et accessible'
        }

        always {
            echo 'üßπ Nettoyage de l\'espace de travail...'
            cleanWs()
            echo '‚úÖ Pipeline termin√©'
        }
    }
}